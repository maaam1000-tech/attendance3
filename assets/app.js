
async function loadJSON(p){const r=await fetch(p);return await r.json()}
function render(rows){const tb=document.getElementById('att');tb.innerHTML='';rows.forEach(r=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${r.national_id}</td><td>${r.name}</td><td>${r.branch}</td><td>${r.date}</td><td>${r.check_in||''}</td><td>${r.check_out||''}</td><td>${r.status||''}</td>`;tb.appendChild(tr);})}
function filterRows(all){const id=(document.getElementById('f-id').value||'').trim();const date=(document.getElementById('f-date').value||'').trim();const br=(document.getElementById('f-branch').value||'').trim();return all.filter(r=>(!id||String(r.national_id).includes(id))&&(!date||r.date===date)&&(!br||r.branch.includes(br)));}
function downloadCSV(rows){const header=['الهوية','الاسم','الفرع','التاريخ','الدخول','الخروج','الحالة'];const lines=[header.join(',')].concat(rows.map(r=>[r.national_id,r.name,r.branch,r.date,r.check_in||'',r.check_out||'',r.status||''].join(',')));const blob=new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='attendance.csv';document.body.appendChild(a);a.click();setTimeout(()=>{URL.revokeObjectURL(url);a.remove();},1000);}
document.addEventListener('DOMContentLoaded',async()=>{const all=await loadJSON('data/attendance.json');let view=all.slice();render(view);['f-id','f-date','f-branch'].forEach(id=>document.getElementById(id).addEventListener('input',()=>{view=filterRows(all);render(view);}));document.getElementById('btn-csv').addEventListener('click',()=>downloadCSV(view));});
